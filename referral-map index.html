<!DOCTYPE html>
<html>
<head>
    <title>Jinja Referral Network Analyzer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style> #map { height: 600px; } </style>
</head>
<body>
    <div id="map"></div>
<script>
    // Jinja coords: JRRH [0.431111, 33.205], HCIVs from PPT
    const jrrh = [0.431111, 33.205000];
    const hcivs = {
        buwenge:  [0.65229, 33.16965],
        walukuba: [0.43824, 33.22508],
        budondo:  [0.51725, 33.16165],
        mpumudde: [0.45993, 33.21235],
        bugembe:  [0.46433, 33.23708]
    };

    // Init Leaflet map centered on Jinja
    const map = L.map('map').setView([0.45, 33.20], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Nice names for HCIVs
    const hcivNames = {
        buwenge:  'Buwenge HCIV',
        budondo:  'Budondo HCIV',
        mpumudde: 'Mpumudde HCIV',
        bugembe:  'Bugembe HCIV',
        walukuba: 'Walukuba HCIV'
    };

    // Add HCIV/JRRH markers
    L.marker(jrrh)
      .addTo(map)
      .bindPopup('Jinja Regional Referral Hospital (JRRH)');

    Object.entries(hcivs).forEach(([key, coord]) => {
        const label = hcivNames[key] || key;
        L.marker(coord)
          .addTo(map)
          .bindPopup(label);
    });

    // ---- GraphHopper routing helper (ONE place to set your key) ----
    const API_KEY = '6feeb3a1-2f8e-4318-b461-594af3cd394a';

    function getRoute(profile, start, end) {
        const url =
            'https://graphhopper.com/api/1/route' +
            `?point=${start[0]},${start[1]}` +
            `&point=${end[0]},${end[1]}` +
            `&profile=${profile}` +
            '&points_encoded=false' +
            `&key=${API_KEY}`;

        return fetch(url)
            .then(r => r.json())
            .then(data => {
                const path = data.paths[0];
                const coords = path.points.coordinates.map(c => [c[1], c[0]]);
                const distanceKm = (path.distance / 1000).toFixed(1);
                const timeMin = (path.time / 60000).toFixed(0);
                return { profile, coords, distanceKm, timeMin };
            });
    }

   // Draw routes directly (no roads layer yet)
Object.entries(hcivs).forEach(([key, coord]) => {
    const start = coord;
    const end = jrrh;

    Promise.all([
        getRoute('foot', start, end),  // walking only
        getRoute('car', start, end)    // motorized
    ])
    .then(results => {
        const routeA = results[0];
        const routeB = results[1];

        const best =
            parseInt(routeA.timeMin) <= parseInt(routeB.timeMin)
                ? routeA
                : routeB;
        const other =
            best === routeA ? routeB : routeA;

        const label = hcivNames[key] || key;

        // Most effective (shortest time) in red
        L.polyline(best.coords, {
            color: 'red',
            weight: 5
        })
        .addTo(map)
        .bindPopup(
            `${label} → JRRH<br>` +
            `Most effective: ${best.profile}<br>` +
            `${best.distanceKm} km, ${best.timeMin} min`
        );

        // Alternative in blue, dashed
        L.polyline(other.coords, {
            color: 'blue',
            weight: 3,
            dashArray: '5,5'
        })
        .addTo(map)
        .bindPopup(
            `${label} → JRRH<br>` +
            `Alternative: ${other.profile}<br>` +
            `${other.distanceKm} km, ${other.timeMin} min`
        );
    })
    .catch(err => console.error('Routing error for', key, err));
});
// Simple legend control
const legend = L.control({ position: 'bottomright' });

legend.onAdd = function (map) {
    const div = L.DomUtil.create('div', 'info legend');
    div.style.background = 'white';
    div.style.padding = '6px 8px';
    div.style.font = '14px/16px Arial, Helvetica, sans-serif';
    div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';

    div.innerHTML =
        '<b>Referral routes</b><br>' +
        '<span style="display:inline-block;width:20px;height:3px;background:red;margin-right:6px;"></span>' +
        'Most effective (shortest time)<br>' +
        '<span style="display:inline-block;width:20px;height:3px;border-top:3px dashed blue;margin-right:6px;"></span>' +
        'Alternative route';
    return div;
};

legend.addTo(map);
</script>

